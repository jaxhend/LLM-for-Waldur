# Base image
FROM ghcr.io/astral-sh/uv:python3.12-bookworm-slim

WORKDIR /app

# Install system dependencies
RUN apt-get update && apt-get install -y git \
    && rm -rf /var/lib/apt/lists/*

# Copy backend source code
RUN git clone --branch main --depth 1 https://github.com/jaxhend/LLM-for-Waldur.git /app
WORKDIR /app/backend

# Add non-root user
RUN useradd --system --create-home --home-dir /home/appuser appuser \
    && chown -R appuser /app
USER appuser

# Install Python dependencies from pyproject.toml
RUN uv sync

# Expose FastAPI port
EXPOSE 8000

# Production entrypoint with Gunicorn + Uvicorn workers
CMD ["uv", "run", "gunicorn", "-c", "app/gunicorn_conf.py", "app.main:app"]
