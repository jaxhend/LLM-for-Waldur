# Base image
FROM ghcr.io/astral-sh/uv:python3.12-bookworm-slim

WORKDIR /ollama_sidecar

# Copy backend source code (context is ./ollama_sidecar)
COPY ./ /ollama_sidecar
WORKDIR /ollama_sidecar

# Add non-root user
RUN useradd --system --create-home --home-dir /home/appuser appuser \
    && chown -R appuser /ollama_sidecar
USER appuser

# Install Python dependencies from pyproject.toml
RUN uv sync

# Production entrypoint with Gunicorn + Uvicorn workers
CMD ["uv", "run", "ollama_worker.py"]
