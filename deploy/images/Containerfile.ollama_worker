# Base image
FROM ghcr.io/astral-sh/uv:python3.12-bookworm-slim

WORKDIR /app

# Copy backend source code (context is ./backend)
COPY ./ollama_sidecar/. /app/ollama_sidecar/

WORKDIR /app/ollama_sidecar

# Add non-root user
RUN useradd --system --create-home --home-dir /home/appuser appuser \
    && chown -R appuser /app
USER appuser

# Install Python dependencies from pyproject.toml
RUN uv sync

# Production entrypoint with Gunicorn + Uvicorn workers
CMD ["uv", "run", "gunicorn", "-c", "app/ollama_worker.py", "app.main:app"]
